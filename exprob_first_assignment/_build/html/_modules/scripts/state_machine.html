<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>scripts.state_machine &mdash; exprob_first_assignment 2.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> exprob_first_assignment
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <!-- Local TOC -->
              <div class="local-toc"></div>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">exprob_first_assignment</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">Module code</a> &raquo;</li>
      <li>scripts.state_machine</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for scripts.state_machine</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>

<span class="c1"># HOW TO RUN</span>

<span class="c1"># - run the ARMOR server</span>
<span class="c1">#          $ rosrun armor execute it.emarolab.armor.ARMORMainService</span>
<span class="c1"># - run the &#39;roscore&#39; and then you can launch the SW architecture</span>
<span class="c1">#          $ roslaunch exprob_first_assignment software_architecture.launch ontology_path:=&quot;path-to-the-topological-map-folder&quot; ontology_name:=&quot;name-of-the-constructed-ontology&quot;</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">.. module:: state_machine</span>
<span class="sd">    :platform: Unix</span>
<span class="sd">    :synopsis: Python module that implements a state_machine to manage the behaviour of the robot</span>

<span class="sd">.. moduleauthor:: Emanuele Rambaldi &lt;emanuele.rambaldi3@studio.unibo.it&gt;</span>

<span class="sd">|  This node interacts with the other nodes of the software architecture in order to determine the desired behaviour of the robot. </span>
<span class="sd">|  Specifically, first of all it sets the initial position of the robot, by communicating it to the &#39;robot-states&#39; node. The proper state-machine, composed of 6 states, is then started.</span>
<span class="sd">|  Once the node enters the firs state (&#39;BuildEnvironment&#39;), a GUI is printed on the screen, asking for the environment&#39;s characteristics. After that, the desired environment is built, by communicating with the ARMOR server.</span>
<span class="sd">|  In other words, a series of requests is issued to the ARMOR server, which takes care of the actual creation of the ontology. The control is then passed to the second state (&#39;Reason&#39;). </span>
<span class="sd">|  This is in charge of querying the ontology about the rooms adjacent to the one the robot is in. Based on the decision taken in this state, the robot is instructed to go either in an adjacent urgent room or in an adjacent corridor. </span>
<span class="sd">|  In order to accomplish this task, in a new state (&#39;Navigate&#39;), first a request is issued to the planner server (&#39;planner&#39; node) so as to retrieve a path towards the desired destinetion. </span>
<span class="sd">|  Then, the evaluated path is forwarded to the controller server (&#39;controller node&#39;) via another request, in order to guide the robot towards the location at issue. </span>
<span class="sd">|  Once the desired location has been reached, the state changes again (&#39;Wait&#39;) and the robot &#39;sleeps&#39; for a little time, simulating the room exploration. </span>
<span class="sd">|  Whatever the state the robot is in, if a &#39;battery_low&#39; message is sent on the corresponding topic by the &#39;robot-states&#39; node, the robot is instructed to drop what it is doing and navigate to the charging room to recharge its battery.</span>
<span class="sd">|  Specifically, first the state changes to &#39;NavigatetoCharge&#39;, whereby the same mechanism as the state &#39;Navigate&#39; is carried out. Then, the node enters the state called &#39;Charge&#39;, that simulates the act of recharging the robot&#39;s battery.</span>
<span class="sd">|  After that, the control is passed again to the state &#39;Reason&#39; and the cycle repeats.</span>


<span class="sd">Subscribes to:</span>
<span class="sd">    - /state/battery_low</span>

<span class="sd">Client:</span>
<span class="sd">    - /state/set_pose</span>
<span class="sd">    - /armor_interface_srv</span>

<span class="sd">Action client:</span>
<span class="sd">    - motion/planner</span>
<span class="sd">    - motion/controller</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># IMPORTS</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">.custom_classes</span> <span class="kn">import</span> <span class="n">EnvironmentOntology</span> <span class="c1"># import the EnvironmentOntology class to define a new ontology and interact with it</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">http.client</span> <span class="kn">import</span> <span class="n">USE_PROXY</span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Lock</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">roslib</span>
<span class="kn">import</span> <span class="nn">rospy</span>
<span class="kn">import</span> <span class="nn">smach</span>
<span class="kn">import</span> <span class="nn">smach_ros</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">functools</span>


<span class="kn">from</span> <span class="nn">std_msgs.msg</span> <span class="kn">import</span> <span class="n">String</span><span class="p">,</span> <span class="n">Float64</span><span class="p">,</span> <span class="n">Bool</span><span class="p">,</span> <span class="n">Float32</span>
<span class="kn">from</span> <span class="nn">geometry_msgs.msg</span> <span class="kn">import</span> <span class="n">Twist</span>
<span class="kn">from</span> <span class="nn">exprob_first_assignment.msg</span> <span class="kn">import</span> <span class="n">Point</span>
<span class="kn">from</span> <span class="nn">exprob_first_assignment.srv</span> <span class="kn">import</span> <span class="n">SetPose</span><span class="p">,</span> <span class="n">SetPoseResponse</span>
<span class="kn">import</span> <span class="nn">exprob_first_assignment</span>  <span class="c1"># This is required to pass the `PlanAction` and `ControlAction` type for instantiating the `SimpleActionClient`.</span>

<span class="kn">from</span> <span class="nn">armor_msgs.srv</span> <span class="kn">import</span> <span class="n">ArmorDirective</span><span class="p">,</span> <span class="n">ArmorDirectiveRequest</span><span class="p">,</span> <span class="n">ArmorDirectiveResponse</span>
<span class="kn">from</span> <span class="nn">armor_msgs.srv</span> <span class="kn">import</span> <span class="n">ArmorDirectiveList</span><span class="p">,</span> <span class="n">ArmorDirectiveListRequest</span><span class="p">,</span> <span class="n">ArmorDirectiveListResponse</span>

<span class="kn">import</span> <span class="nn">actionlib</span>
<span class="kn">import</span> <span class="nn">actionlib.msg</span>
<span class="kn">from</span> <span class="nn">exprob_first_assignment.msg</span> <span class="kn">import</span> <span class="n">PlanAction</span><span class="p">,</span> <span class="n">PlanGoal</span>
<span class="kn">from</span> <span class="nn">exprob_first_assignment.msg</span> <span class="kn">import</span> <span class="n">ControlAction</span><span class="p">,</span> <span class="n">ControlGoal</span>

<span class="c1">#==================================================================================================================</span>

<span class="c1"># GLOBAL VARIABLES</span>

<span class="c1"># global action clients</span>
<span class="n">actcli_plan</span> <span class="o">=</span> <span class="n">actionlib</span><span class="o">.</span><span class="n">SimpleActionClient</span><span class="p">(</span><span class="s1">&#39;motion/planner&#39;</span><span class="p">,</span> <span class="n">PlanAction</span><span class="p">)</span> <span class="c1">#initialize and define the global action client that sends requests belonging to the &#39;motion/planner&#39; action</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Global action client the task of which is to ask the &#39;planner&#39; server to generate a path towards a desired location</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">actcli_control</span> <span class="o">=</span> <span class="n">actionlib</span><span class="o">.</span><span class="n">SimpleActionClient</span><span class="p">(</span><span class="s1">&#39;motion/controller&#39;</span><span class="p">,</span> <span class="n">ControlAction</span><span class="p">)</span> <span class="c1">#initialize and define the global action client that sends requests belonging to the &#39;motion/controller&#39; action</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Global action client the task of which is to ask the &#39;controller&#39; server to guide the robot towards a desired location along a given path</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># global variables and constants</span>
<span class="n">transition</span> <span class="o">=</span> <span class="s1">&#39;no_transition&#39;</span> <span class="c1">#global variable containing the current transition</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Global string variable containing the current transition</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># mutexes</span>
<span class="n">mutex</span><span class="o">=</span><span class="n">Lock</span><span class="p">()</span> <span class="c1">#initialize and define a mutex that will manage the access to the global variable &#39;transition&#39;</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Global mutex to manage the access to the global variable &#39;transition&#39;</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1">#==================================================================================================================</span>

<span class="c1"># SUBSCRIBERS CALLBACK FUNCTIONS</span>

<div class="viewcode-block" id="clbk_battery"><a class="viewcode-back" href="../../index.html#scripts.state_machine.clbk_battery">[docs]</a><span class="k">def</span> <span class="nf">clbk_battery</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Function that is called every time that a new message is published on the &#39;/state/battery_low&#39; topic.</span>

<span class="sd">    The function is aimed at catching the messages published on the topic by the &#39;robot-states&#39; node and changing the value of the global variable &#39;transition&#39; so as to make the state-machine evolve into the &#39;NavigatetoCharge&#39; state.</span>

<span class="sd">    Args:</span>
<span class="sd">        msg (Bool): in priciple always set to &#39;True&#39; to warn the state-mchine about the fact that the battery is low</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">global</span> <span class="n">transition</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="kc">True</span><span class="p">):</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[91m&#39;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">## The battery of the robot got low ##&quot;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[0m&#39;</span><span class="p">)</span>

        <span class="n">mutex</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># print(&#39;\033[93m&#39; + &quot;\nclbk_battery got the mutex&quot; + &#39;\033[0m&#39;) # DEBUG</span>
            <span class="n">transition</span> <span class="o">=</span> <span class="s1">&#39;battery_low&#39;</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">mutex</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[91m&#39;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Unrecognized message coming from the &#39;robot-states&#39; node&quot;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[0m&#39;</span><span class="p">)</span></div>

<span class="c1">#==================================================================================================================</span>

<span class="c1"># GUI FUNCTION </span>

<div class="viewcode-block" id="gui_function"><a class="viewcode-back" href="../../index.html#scripts.state_machine.gui_function">[docs]</a><span class="k">def</span> <span class="nf">gui_function</span><span class="p">():</span>

    <span class="sd">&quot;&quot;&quot;Function that prints on the screen a GUI to guide the user in building the desired environment.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">tot_n_rooms</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;How many rooms does the flat have? [max 9] &quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">tot_n_rooms</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tot_n_rooms</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[91m&#39;</span> <span class="o">+</span> <span class="s2">&quot;The input is not an integer number&quot;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[0m&#39;</span> <span class="o">+</span> <span class="s2">&quot; -&gt; try again&quot;</span><span class="p">)</span>

        <span class="k">if</span><span class="p">(</span><span class="n">tot_n_rooms</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">tot_n_rooms</span> <span class="o">&gt;</span> <span class="mi">9</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[91m&#39;</span> <span class="o">+</span> <span class="s2">&quot;The input is out of bounds&quot;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[0m&#39;</span> <span class="o">+</span> <span class="s2">&quot; -&gt; try again&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="n">n_rooms_left</span> <span class="o">=</span> <span class="n">tot_n_rooms</span>
    <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">tot_n_corridors</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;How many corridors does the flat have? [max 5] &quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">tot_n_corridors</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tot_n_corridors</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[91m&#39;</span> <span class="o">+</span> <span class="s2">&quot;The input is not an integer number&quot;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[0m&#39;</span> <span class="o">+</span> <span class="s2">&quot; -&gt; try again&quot;</span><span class="p">)</span>

        <span class="k">if</span><span class="p">(</span><span class="n">tot_n_corridors</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">tot_n_corridors</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">):</span> <span class="c1"># if the total number of corridors is 0, there is no problem because the charging room is present anyway and it is a corridor -&gt; that&#39;s why i put tot_n_corridors &lt; 0 and not tot_n_corridors &lt; 1</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[91m&#39;</span> <span class="o">+</span> <span class="s2">&quot;The input is out of bounds&quot;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[0m&#39;</span> <span class="o">+</span> <span class="s2">&quot; -&gt; try again&quot;</span><span class="p">)</span>
        <span class="k">elif</span><span class="p">(</span><span class="n">tot_n_corridors</span> <span class="o">&gt;</span> <span class="n">tot_n_rooms</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[91m&#39;</span> <span class="o">+</span> <span class="s2">&quot;The input cannot be more than the number of rooms&quot;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[0m&#39;</span> <span class="o">+</span> <span class="s2">&quot; -&gt; try again&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">break</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">tot_n_corridors</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">rooms_corridor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">tot_n_corridors</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">tot_n_corridors</span><span class="p">):</span>
            <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">n_rooms</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;How many rooms does corridor </span><span class="si">{0}</span><span class="s2"> have? [min 1 ; max </span><span class="si">{1}</span><span class="s2">] &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">n_rooms_left</span><span class="o">-</span><span class="p">(</span><span class="n">tot_n_corridors</span><span class="o">-</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">))))</span> <span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">n_rooms</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_rooms</span><span class="p">)</span>
                        <span class="k">break</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[91m&#39;</span> <span class="o">+</span> <span class="s2">&quot;The input is not an integer number&quot;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[0m&#39;</span> <span class="o">+</span> <span class="s2">&quot; -&gt; try again&quot;</span><span class="p">)</span>

                <span class="k">if</span><span class="p">(</span><span class="n">n_rooms</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">n_rooms</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">n_rooms_left</span><span class="o">-</span><span class="p">(</span><span class="n">tot_n_corridors</span><span class="o">-</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)))):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[91m&#39;</span> <span class="o">+</span> <span class="s2">&quot;The input is out of bounds&quot;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[0m&#39;</span> <span class="o">+</span> <span class="s2">&quot; -&gt; try again&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">break</span>

            <span class="k">if</span><span class="p">(</span><span class="n">n_rooms</span> <span class="o">!=</span> <span class="p">(</span><span class="n">n_rooms_left</span><span class="o">-</span><span class="p">(</span><span class="n">tot_n_corridors</span><span class="o">-</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)))):</span>
                <span class="n">rooms_corridor</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">n_rooms</span>
                <span class="n">n_rooms_left</span><span class="o">=</span><span class="n">n_rooms_left</span><span class="o">-</span><span class="n">n_rooms</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rooms_corridor</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">n_rooms</span>
                <span class="n">n_rooms_left</span><span class="o">=</span><span class="n">n_rooms_left</span><span class="o">-</span><span class="n">n_rooms</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[94m&#39;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">All the remaining corridors have necessarily 1 room&quot;</span>  <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[0m&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">tot_n_corridors</span><span class="p">):</span>
                    <span class="n">rooms_corridor</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
                    <span class="n">n_rooms_left</span><span class="o">=</span><span class="n">n_rooms_left</span><span class="o">-</span><span class="mi">1</span>
                <span class="k">break</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">tot_n_corridors</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The &quot;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[92m&#39;</span> <span class="o">+</span> <span class="s2">&quot;corridor </span><span class="si">{0}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[0m&#39;</span> <span class="o">+</span> <span class="s2">&quot;has &quot;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[92m&#39;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> rooms &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rooms_corridor</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[0m&#39;</span> <span class="o">+</span> <span class="s2">&quot;then&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rooms_corridor</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The &quot;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[92m&#39;</span> <span class="o">+</span> <span class="s2">&quot;charging room &quot;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[0m&#39;</span> <span class="o">+</span> <span class="s2">&quot;has all the remaining rooms, therefore &quot;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[92m&#39;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> rooms&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n_rooms_left</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[0m&#39;</span><span class="p">)</span>


    <span class="k">if</span> <span class="p">(</span><span class="n">tot_n_corridors</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Now answer &#39;yes&#39; or &#39;no&#39; to the following question:&quot;</span><span class="p">)</span>
        <span class="n">connection</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">tot_n_corridors</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">tot_n_corridors</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">answer</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Is corridor </span><span class="si">{0}</span><span class="s2"> connected to corridor </span><span class="si">{1}</span><span class="s2">? &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">))</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">answer</span> <span class="o">==</span> <span class="s1">&#39;yes&#39;</span> <span class="ow">or</span> <span class="n">answer</span> <span class="o">==</span> <span class="s1">&#39;Yes&#39;</span> <span class="ow">or</span> <span class="n">answer</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span> <span class="ow">or</span> <span class="n">answer</span> <span class="o">==</span> <span class="s1">&#39;Y&#39;</span><span class="p">):</span>
                    <span class="n">connection</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">answer</span> <span class="o">==</span> <span class="s1">&#39;no&#39;</span> <span class="ow">or</span> <span class="n">answer</span> <span class="o">==</span> <span class="s1">&#39;No&#39;</span> <span class="ow">or</span> <span class="n">answer</span> <span class="o">==</span> <span class="s1">&#39;n&#39;</span> <span class="ow">or</span> <span class="n">answer</span> <span class="o">==</span> <span class="s1">&#39;N&#39;</span><span class="p">):</span>
                    <span class="n">connection</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[91m&#39;</span> <span class="o">+</span> <span class="s2">&quot;The input is neither &#39;yes&#39; nor &#39;no&#39;&quot;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[0m&#39;</span> <span class="o">+</span> <span class="s2">&quot; -&gt; try again&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">tot_n_corridors</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">connection</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The &quot;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[92m&#39;</span> <span class="o">+</span> <span class="s2">&quot;corridor </span><span class="si">{0}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[0m&#39;</span> <span class="o">+</span> <span class="s2">&quot;is connected to the &quot;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[92m&#39;</span> <span class="o">+</span> <span class="s2">&quot;corridor </span><span class="si">{0}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[0m&#39;</span> <span class="o">+</span> <span class="s2">&quot;then&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The &quot;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[92m&#39;</span> <span class="o">+</span> <span class="s2">&quot;corridor </span><span class="si">{0}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[0m&#39;</span> <span class="o">+</span> <span class="s2">&quot;is &quot;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[94m&#39;</span> <span class="o">+</span> <span class="s2">&quot;NOT &quot;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[0m&#39;</span> <span class="o">+</span> <span class="s2">&quot;connected to the &quot;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[92m&#39;</span> <span class="o">+</span> <span class="s2">&quot;corridor </span><span class="si">{0}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[0m&#39;</span> <span class="o">+</span> <span class="s2">&quot;then&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">connection</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The &quot;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[92m&#39;</span> <span class="o">+</span> <span class="s2">&quot;charging room &quot;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[0m&#39;</span> <span class="o">+</span> <span class="s2">&quot;is connected to all the corridors by hypothesis&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">tot_n_rooms</span><span class="p">,</span> <span class="n">tot_n_corridors</span><span class="p">,</span> <span class="n">rooms_corridor</span><span class="p">,</span> <span class="n">n_rooms_left</span><span class="p">,</span> <span class="n">connection</span></div>

<span class="c1">#==================================================================================================================</span>

<span class="c1"># REGULAR FUNCTIONS</span>

<div class="viewcode-block" id="set_initial_pose"><a class="viewcode-back" href="../../index.html#scripts.state_machine.set_initial_pose">[docs]</a><span class="k">def</span> <span class="nf">set_initial_pose</span><span class="p">():</span>

    <span class="sd">&quot;&quot;&quot;Function that is called in order to send requests belonging to the &#39;/state/set_pose&#39; service.</span>

<span class="sd">    |  After the service is defined and initialised, the inital pose of the robot is retrieved from the parameter server. Then, this pose is sent in form of request to the server. </span>
<span class="sd">    |  The user is notified both if the service call fails and if it succeds.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">cli_setpose</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">ServiceProxy</span><span class="p">(</span><span class="s1">&#39;/state/set_pose&#39;</span><span class="p">,</span><span class="n">SetPose</span><span class="p">)</span> <span class="c1">#initialize and define the client that sends requests belonging to the service &#39;/state/set_pose&#39; of type &#39;SetPose&#39;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[92m&#39;</span> <span class="o">+</span> <span class="s2">&quot;Communicating to the &#39;robot-states&#39; node the initial position of the robot...&quot;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[0m&#39;</span><span class="p">)</span>

    <span class="n">initial_pose</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="s1">&#39;/state/initial_pose&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">])</span> <span class="c1"># retrieve the initial pose of the robot from the parameter server.</span>
    <span class="c1"># This pose should be within the environmet_size -&gt; [0.0,0.0] is the default initial pose.</span>

    <span class="n">setpose_req</span> <span class="o">=</span> <span class="n">Point</span><span class="p">()</span>

    <span class="n">setpose_req</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">initial_pose</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">setpose_req</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">initial_pose</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- The robot initial coordinates are:</span><span class="se">\n</span><span class="s2">  x: </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">  y: </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">setpose_req</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">setpose_req</span><span class="o">.</span><span class="n">y</span><span class="p">))</span>

    <span class="n">rospy</span><span class="o">.</span><span class="n">wait_for_service</span><span class="p">(</span><span class="s1">&#39;/state/set_pose&#39;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">cli_setpose</span><span class="p">(</span><span class="n">setpose_req</span><span class="p">)</span> <span class="c1"># initial_pose is retrieved from the state/initial_pose parameter and it is hereafter set in the robot-state node as the initial position of the robot</span>
    <span class="k">except</span> <span class="n">rospy</span><span class="o">.</span><span class="n">ServiceException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Service call failed: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">e</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- The robot initial coordinates have been communicated correctly&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span></div>

<span class="c1">#----------------------------------------------------------------------------</span>

<div class="viewcode-block" id="generate_lists"><a class="viewcode-back" href="../../index.html#scripts.state_machine.generate_lists">[docs]</a><span class="k">def</span> <span class="nf">generate_lists</span><span class="p">(</span><span class="n">tot_n_corridors</span><span class="p">,</span> <span class="n">tot_n_rooms</span><span class="p">,</span> <span class="n">connection</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Function that given some pieces of information about the desired environment, generates a list of labels for each kind of item.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        tot_n_corridors (int): total number of corridors in the desired environment</span>
<span class="sd">        tot_n_rooms (int): total number of rooms in the desired environment</span>
<span class="sd">        connection (Bool array): array containing information about the connection between adjacent corridors in the desired environment</span>

<span class="sd">    Returns:</span>
<span class="sd">        doors_list (str list): list containing the lables associated with all the doors in the environment</span>
<span class="sd">        rooms_list (str list): list containing the lables associated with all the rooms in the environment</span>
<span class="sd">        corridors_list (str list): list containing the lables associated with all the corridors in the environment</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[92m&#39;</span> <span class="o">+</span> <span class="s2">&quot;The desired environment is composed by the following instances:&quot;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[0m&#39;</span><span class="p">)</span>

    <span class="c1"># Create a list containing all the doors</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- Doors:&quot;</span><span class="p">)</span>
    <span class="n">doors_list</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># define an empty list</span>
    <span class="k">if</span> <span class="n">tot_n_corridors</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">tot_n_rooms</span><span class="o">+</span><span class="n">tot_n_corridors</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">connection</span><span class="p">)):</span> <span class="c1"># np.count_nonzero() counts the number of True slots in the array</span>
            <span class="n">doors_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;D&quot;</span><span class="o">+</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">doors_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">tot_n_rooms</span><span class="o">+</span><span class="n">tot_n_corridors</span><span class="p">):</span>
            <span class="n">doors_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;D&quot;</span><span class="o">+</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">doors_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    
    <span class="c1"># Create a list containing all the rooms</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- Rooms:&quot;</span><span class="p">)</span>
    <span class="n">rooms_list</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># define an empty list</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">tot_n_rooms</span><span class="p">):</span>
        <span class="n">rooms_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;R&quot;</span><span class="o">+</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">rooms_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

    <span class="c1"># Create a list containing all the corridors</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- Corridors:&quot;</span><span class="p">)</span>
    <span class="n">corridors_list</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># define an empty list</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">tot_n_corridors</span><span class="p">):</span>
        <span class="n">corridors_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;C&quot;</span><span class="o">+</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">corridors_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

    <span class="k">return</span><span class="p">(</span><span class="n">doors_list</span><span class="p">,</span> <span class="n">rooms_list</span> <span class="p">,</span><span class="n">corridors_list</span><span class="p">)</span></div>

<span class="c1">#----------------------------------------------------------------------------</span>

<div class="viewcode-block" id="cancel_control_goals"><a class="viewcode-back" href="../../index.html#scripts.state_machine.cancel_control_goals">[docs]</a><span class="k">def</span> <span class="nf">cancel_control_goals</span><span class="p">():</span>

    <span class="sd">&quot;&quot;&quot;Function that is called in order to send requests belonging to the &#39;motion/controller&#39; action service.</span>

<span class="sd">    The function is simply aimed at cancelling all pending control goals.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&gt; Cancelling previous control goals...&quot;</span><span class="p">)</span>

    <span class="n">actcli_control</span><span class="o">.</span><span class="n">wait_for_server</span><span class="p">()</span>
    <span class="n">actcli_control</span><span class="o">.</span><span class="n">cancel_all_goals</span><span class="p">()</span> <span class="c1">#cancel all previous control goals</span></div>

<span class="c1">#----------------------------------------------------------------------------</span>

<div class="viewcode-block" id="plan"><a class="viewcode-back" href="../../index.html#scripts.state_machine.plan">[docs]</a><span class="k">def</span> <span class="nf">plan</span><span class="p">(</span><span class="n">location</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Function that is called in order to send requests belonging to the &#39;motion/planner&#39; action service.</span>

<span class="sd">    |  First, the goal location passed as argument is sent in form of request to the action server. Then, the process waits for the path towards the location to be generated.</span>
<span class="sd">    |  When the action server provides the path, it is stored in a variable and returned.</span>

<span class="sd">    Args:</span>
<span class="sd">        location (str): label of the location that the robot has to reach</span>

<span class="sd">    Returns:</span>
<span class="sd">        via_points_list (Point list): list containing random-generated via-points towards the goal location</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&gt; Evaluating a path towards the location &quot;</span> <span class="o">+</span> <span class="n">location</span> <span class="o">+</span> <span class="s2">&quot;...&quot;</span><span class="p">)</span>

    <span class="c1"># set the desired planning goal</span>
    <span class="n">goal_planner</span> <span class="o">=</span> <span class="n">PlanGoal</span><span class="p">()</span>
    <span class="n">goal_planner</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="n">location</span>

    <span class="n">actcli_plan</span><span class="o">.</span><span class="n">wait_for_server</span><span class="p">()</span>
    <span class="c1"># Send a new `goal_planner`, which is a message of type `PlanGoal`</span>
    <span class="n">actcli_plan</span><span class="o">.</span><span class="n">send_goal</span><span class="p">(</span><span class="n">goal_planner</span><span class="p">)</span>

    <span class="c1"># Waits for the server to finish performing the action</span>
    <span class="n">actcli_plan</span><span class="o">.</span><span class="n">wait_for_result</span><span class="p">()</span>

    <span class="c1"># Gets the result of executing the action</span>
    <span class="n">via_points_list</span> <span class="o">=</span> <span class="n">ControlGoal</span><span class="p">()</span>
    <span class="n">via_points_list</span> <span class="o">=</span> <span class="n">actcli_plan</span><span class="o">.</span><span class="n">get_result</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">via_points_list</span></div>

<span class="c1">#----------------------------------------------------------------------------</span>

<div class="viewcode-block" id="control"><a class="viewcode-back" href="../../index.html#scripts.state_machine.control">[docs]</a><span class="k">def</span> <span class="nf">control</span><span class="p">(</span><span class="n">via_points_list</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Function that is called in order to send requests belonging to the &#39;motion/controller&#39; action service.</span>

<span class="sd">    The function sends the list of via-points passed as argument in form of request to the action server.</span>

<span class="sd">    Args:</span>
<span class="sd">        via_points_list (Point list): list containing random-generated via-points towards the goal location</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&gt; Controlling the robot towards the desired location...&quot;</span><span class="p">)</span>

    <span class="n">actcli_control</span><span class="o">.</span><span class="n">wait_for_server</span><span class="p">()</span>
    <span class="c1"># Send the via points list retrieved by the planner to the controller</span>
    <span class="n">actcli_control</span><span class="o">.</span><span class="n">send_goal</span><span class="p">(</span><span class="n">via_points_list</span><span class="p">)</span></div>


<span class="c1">#==================================================================================================================   </span>

<span class="c1"># STATES </span>

<span class="c1"># define state Reason</span>
<div class="viewcode-block" id="BuildEnvironment"><a class="viewcode-back" href="../../index.html#scripts.state_machine.BuildEnvironment">[docs]</a><span class="k">class</span> <span class="nc">BuildEnvironment</span><span class="p">(</span><span class="n">smach</span><span class="o">.</span><span class="n">State</span><span class="p">,</span><span class="n">EnvironmentOntology</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Class that defines a state whereby the environment is created as the user desires.</span>

<span class="sd">    .. note::</span>

<span class="sd">        |  The only possible outcome of the implemented state is the string &#39;environment_built&#39;.</span>
<span class="sd">        |  The variable &#39;sm_targetloc&#39; shared among the states here is referred as: &#39;buildenvironment_targetloc_in&#39; (as far as the input value is concerned) and &#39;buildenvironment_targetloc_out&#39; (as far as the output value is concerned).</span>
<span class="sd">        |  It contains the location the robot should reach.</span>
<span class="sd">        |  The variable &#39;sm_prevstate&#39; shared among the states here is referred as: &#39;buildenvironment_prevstate_in&#39; (as far as the input value is concerned) and &#39;buildenvironment_prevstate_out&#39; (as far as the output value is concerned).</span>
<span class="sd">        |  It contains the previous state identifier.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot; (constructor) Function that is called whenever an instance of this class is defined.</span>

<span class="sd">        The function mainly executes the constructor of the father class &#39;EnvironmentOntology&#39; so as to inherit the attributes defined in there.</span>

<span class="sd">        Args:</span>
<span class="sd">            self: variable that refers to the class instance</span>
<span class="sd">            outcomes (str list): list containing all the possible strings that make the process exit this state</span>
<span class="sd">            input_keys (str list): list containing the names of the input variables used in this state</span>
<span class="sd">            output_keys (str list): list containing the names of the output variables used in this state</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># initialisation function, it should not wait</span>
        <span class="n">smach</span><span class="o">.</span><span class="n">State</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                             <span class="n">outcomes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;environment_built&#39;</span><span class="p">],</span>
                             <span class="n">input_keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;buildenvironment_targetloc_in&#39;</span><span class="p">,</span><span class="s1">&#39;buildenvironment_prevstate_in&#39;</span><span class="p">],</span>
                             <span class="n">output_keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;buildenvironment_targetloc_out&#39;</span><span class="p">,</span><span class="s1">&#39;buildenvironment_prevstate_out&#39;</span><span class="p">])</span>
        <span class="n">EnvironmentOntology</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="c1"># Execute the constructor of the father class &#39;EnvironmentOntology&#39; so as to inherit the attributes defined in there (self.cli_armordirective)</span>
        
<div class="viewcode-block" id="BuildEnvironment.execute"><a class="viewcode-back" href="../../index.html#scripts.state_machine.BuildEnvironment.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">userdata</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Function that is called every time that this state is executed.</span>

<span class="sd">        |  First, the GUI function is called in order to let the user decide how the environment should be and the retrieved information are stored in lists. Then, the desired environment is built, thanks to a series of requests issued to the ARMOR server, which takes care of the actual creation of the ontology.</span>
<span class="sd">        |  This task is carried out by means of the &#39;build_environment&#39; method belonging to the imported class named &#39;EnvironmentOntology&#39;. Finally the global variable &#39;transition&#39; is assigned with the string &#39;environment_built&#39; and it is returned.</span>

<span class="sd">        Args:</span>
<span class="sd">            self: variable that refers to the class instance</span>
<span class="sd">            userdata (struct): structure containing the input and output variables of the state</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># function called when executing the node, it can be blocking</span>

        <span class="k">global</span> <span class="n">transition</span>
        <span class="k">global</span> <span class="n">mutex</span>

        <span class="n">rospy</span><span class="o">.</span><span class="n">loginfo</span><span class="p">(</span><span class="s1">&#39;Executing state &#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[93m&#39;</span> <span class="o">+</span> <span class="s1">&#39;BUILDENVIRONMENT &#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[0m&#39;</span> <span class="o">+</span> <span class="s1">&#39;(the previous state was: </span><span class="si">%d</span><span class="s1">)&#39;</span><span class="o">%</span><span class="n">userdata</span><span class="o">.</span><span class="n">buildenvironment_prevstate_in</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[93m&#39;</span> <span class="o">+</span> <span class="s1">&#39;-----------------------------------------------------------------------------&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[0m&#39;</span><span class="p">)</span> 


        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[92m&#39;</span> <span class="o">+</span> <span class="s2">&quot;Preprocessing...&quot;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[0m&#39;</span><span class="p">)</span>

        <span class="c1"># retrieve the desired ontology name passed as argument from command line</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">myargv</span><span class="p">(</span><span class="n">argv</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span> <span class="c1">#check on the number of arguments -&gt; one argument(the path to the file) is provided by the system by default -&gt; so it is 1+2 in this case</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[91m&#39;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">too many or not enough arguments provided&quot;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[0m&#39;</span> <span class="o">+</span> <span class="s2">&quot; -&gt; exiting&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">ontology_path</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">ontology_name</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

        <span class="c1"># execute the GUI function</span>
        <span class="n">tot_n_rooms</span><span class="p">,</span> <span class="n">tot_n_corridors</span><span class="p">,</span> <span class="n">rooms_corridor</span><span class="p">,</span> <span class="n">n_rooms_left</span><span class="p">,</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">gui_function</span><span class="p">()</span>
        
        <span class="c1"># create the lists of each class&#39; individuals starting from the information retrieved from the user</span>
        <span class="n">doors_list</span><span class="p">,</span> <span class="n">rooms_list</span><span class="p">,</span> <span class="n">corridors_list</span> <span class="o">=</span> <span class="n">generate_lists</span><span class="p">(</span><span class="n">tot_n_corridors</span><span class="p">,</span> <span class="n">tot_n_rooms</span><span class="p">,</span> <span class="n">connection</span><span class="p">)</span>

        <span class="c1"># retrieve and communicate to the &#39;robot-states&#39; node the robot&#39;s initial position</span>
        <span class="n">set_initial_pose</span><span class="p">()</span>

        <span class="c1"># --------------------</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[92m&#39;</span> <span class="o">+</span> <span class="s2">&quot;Building the desired environment...&quot;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[0m&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">build_environment</span><span class="p">(</span><span class="n">ontology_path</span><span class="p">,</span> <span class="n">ontology_name</span><span class="p">,</span> <span class="n">tot_n_corridors</span><span class="p">,</span> <span class="n">rooms_corridor</span><span class="p">,</span> <span class="n">n_rooms_left</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="n">doors_list</span><span class="p">,</span> <span class="n">corridors_list</span><span class="p">,</span> <span class="n">rooms_list</span><span class="p">)</span>

        <span class="n">mutex</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># print(&#39;\033[93m&#39; + &quot;\nstate BuildEnvironment got the mutex (1)&quot; + &#39;\033[0m&#39;) # DEBUG</span>
            <span class="n">transition</span> <span class="o">=</span> <span class="s1">&#39;environment_built&#39;</span> <span class="c1"># I reset the transition so that from this time on I can catch new transitions</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">mutex</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

        <span class="n">userdata</span><span class="o">.</span><span class="n">buildenvironment_prevstate_out</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[93m&#39;</span> <span class="o">+</span> <span class="s1">&#39;-----------------------------------------------------------------------------&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[0m&#39;</span><span class="p">)</span> 

        <span class="k">return</span> <span class="n">transition</span></div></div>

<span class="c1"># define state Reason</span>
<div class="viewcode-block" id="Reason"><a class="viewcode-back" href="../../index.html#scripts.state_machine.Reason">[docs]</a><span class="k">class</span> <span class="nc">Reason</span><span class="p">(</span><span class="n">smach</span><span class="o">.</span><span class="n">State</span><span class="p">,</span><span class="n">EnvironmentOntology</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Class that defines a state whereby the created ontology is interrogated in order to retrieve information about the locations adjacent to the room that the robot is in.</span>

<span class="sd">    .. note::</span>

<span class="sd">        |  The possible outcomes of the implemented state are the strings &#39;battery_low&#39; and &#39;done_reasoning&#39;.</span>
<span class="sd">        |  The variable &#39;sm_targetloc&#39; shared among the states here is referred as: &#39;reason_targetloc_in&#39; (as far as the input value is concerned) and &#39;reason_targetloc_out&#39; (as far as the output value is concerned).</span>
<span class="sd">        |  It contains the location the robot should reach.</span>
<span class="sd">        |  The variable &#39;sm_prevstate&#39; shared among the states here is referred as: &#39;reason_prevstate_in&#39; (as far as the input value is concerned) and &#39;reason_prevstate_out&#39; (as far as the output value is concerned).</span>
<span class="sd">        |  It contains the previous state identifier.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot; (constructor) Function that is called whenever an instance of this class is defined.</span>

<span class="sd">        The function mainly executes the constructor of the father class &#39;EnvironmentOntology&#39; so as to inherit the attributes defined in there.</span>

<span class="sd">        Args:</span>
<span class="sd">            self: variable that refers to the class instance</span>
<span class="sd">            outcomes (str list): list containing all the possible strings that make the process exit this state</span>
<span class="sd">            input_keys (str list): list containing the names of the input variables used in this state</span>
<span class="sd">            output_keys (str list): list containing the names of the output variables used in this state</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># initialisation function, it should not wait</span>
        <span class="n">smach</span><span class="o">.</span><span class="n">State</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                             <span class="n">outcomes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;battery_low&#39;</span><span class="p">,</span><span class="s1">&#39;done_reasoning&#39;</span><span class="p">],</span>
                             <span class="n">input_keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;reason_targetloc_in&#39;</span><span class="p">,</span><span class="s1">&#39;reason_prevstate_in&#39;</span><span class="p">],</span>
                             <span class="n">output_keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;reason_targetloc_out&#39;</span><span class="p">,</span><span class="s1">&#39;reason_prevstate_out&#39;</span><span class="p">])</span>
        <span class="n">EnvironmentOntology</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> 
    
<div class="viewcode-block" id="Reason.execute"><a class="viewcode-back" href="../../index.html#scripts.state_machine.Reason.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">userdata</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Function that is called every time that this state is executed.</span>

<span class="sd">        |  First, the &#39;urgent_check&#39; method belonging to the imported class named &#39;EnvironmentOntology&#39; is executed to find out if there is an urgent room among the adjacent ones.</span>
<span class="sd">        |  Based on this check, the method at issue returns the location that the robot should reach, which is then stored in the output variable &#39;reason_targetloc_out&#39;. </span>
<span class="sd">        |  Finally, if the value of the global variable &#39;transition&#39; has not changed into &#39;battery low&#39;, it is assigned with the string &#39;done_reasoning&#39; and it is returned.</span>

<span class="sd">        Args:</span>
<span class="sd">            self: variable that refers to the class instance</span>
<span class="sd">            userdata (struct): structure containing the input and output variables of the state</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># function called when executing the node, it can be blocking</span>

        <span class="k">global</span> <span class="n">transition</span>
        <span class="k">global</span> <span class="n">mutex</span>

        <span class="n">rospy</span><span class="o">.</span><span class="n">loginfo</span><span class="p">(</span><span class="s1">&#39;Executing state &#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[93m&#39;</span> <span class="o">+</span> <span class="s1">&#39;REASON &#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[0m&#39;</span> <span class="o">+</span> <span class="s1">&#39;(the previous state was: </span><span class="si">%d</span><span class="s1">)&#39;</span><span class="o">%</span><span class="n">userdata</span><span class="o">.</span><span class="n">reason_prevstate_in</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[93m&#39;</span> <span class="o">+</span> <span class="s1">&#39;-----------------------------------------------------------------------------&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[0m&#39;</span><span class="p">)</span> 

        <span class="n">mutex</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># print(&#39;\033[93m&#39; + &quot;\nstate Reason got the mutex (1)&quot; + &#39;\033[0m&#39;) # DEBUG</span>
            <span class="n">transition</span> <span class="o">=</span> <span class="s1">&#39;no_transition&#39;</span> <span class="c1"># I reset the transition so that from this time on I can catch new transitions</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">mutex</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

        <span class="c1"># --------------------</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&gt; Reasoning...&quot;</span><span class="p">)</span>

        <span class="n">target_location</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">urgent_check</span><span class="p">()</span> <span class="c1"># this function is atomic: can&#39;t be interrupted by a battery_low signal</span>


        <span class="n">mutex</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">if</span><span class="p">(</span><span class="n">transition</span> <span class="o">==</span> <span class="s1">&#39;no_transition&#39;</span><span class="p">):</span>
            <span class="c1"># print(&#39;\033[93m&#39; + &quot;\nstate Reason got the mutex (2)&quot; + &#39;\033[0m&#39;) # DEBUG</span>
            <span class="n">transition</span> <span class="o">=</span> <span class="s1">&#39;done_reasoning&#39;</span>
            <span class="n">userdata</span><span class="o">.</span><span class="n">reason_targetloc_out</span> <span class="o">=</span> <span class="n">target_location</span> <span class="c1"># yield as output shared variable the target location (URGENT or CORRIDOR)</span>
        <span class="n">mutex</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        
        <span class="n">userdata</span><span class="o">.</span><span class="n">reason_prevstate_out</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[93m&#39;</span> <span class="o">+</span> <span class="s1">&#39;-----------------------------------------------------------------------------&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[0m&#39;</span><span class="p">)</span> 
        
        <span class="k">return</span> <span class="n">transition</span></div></div>

<span class="c1"># define state Charge</span>
<div class="viewcode-block" id="Charge"><a class="viewcode-back" href="../../index.html#scripts.state_machine.Charge">[docs]</a><span class="k">class</span> <span class="nc">Charge</span><span class="p">(</span><span class="n">smach</span><span class="o">.</span><span class="n">State</span><span class="p">,</span><span class="n">EnvironmentOntology</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Class that defines a state that simulates the robot&#39;s battery recharging.</span>

<span class="sd">    .. note::</span>

<span class="sd">        |  The possible outcomes of the implemented state are the strings &#39;battery_low&#39; and &#39;battery_full&#39;.</span>
<span class="sd">        |  The variable &#39;sm_targetloc&#39; shared among the states here is referred as: &#39;charge_targetloc_in&#39; (as far as the input value is concerned) and &#39;charge_targetloc_out&#39; (as far as the output value is concerned).</span>
<span class="sd">        |  It contains the location the robot should reach.</span>
<span class="sd">        |  The variable &#39;sm_prevstate&#39; shared among the states here is referred as: &#39;charge_prevstate_in&#39; (as far as the input value is concerned) and &#39;charge_prevstate_out&#39; (as far as the output value is concerned).</span>
<span class="sd">        |  It contains the previous state identifier.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot; (constructor) Function that is called whenever an instance of this class is defined.</span>

<span class="sd">        The function initialises a loop counter and executes the constructor of the father class &#39;EnvironmentOntology&#39; so as to inherit the attributes defined in there.</span>

<span class="sd">        Args:</span>
<span class="sd">            self: variable that refers to the class instance</span>
<span class="sd">            outcomes (str list): list containing all the possible strings that make the process exit this state</span>
<span class="sd">            input_keys (str list): list containing the names of the input variables used in this state</span>
<span class="sd">            output_keys (str list): list containing the names of the output variables used in this state</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># initialisation function, it should not wait</span>
        <span class="n">smach</span><span class="o">.</span><span class="n">State</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                             <span class="n">outcomes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;battery_low&#39;</span><span class="p">,</span><span class="s1">&#39;battery_full&#39;</span><span class="p">],</span>
                             <span class="n">input_keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;charge_targetloc_in&#39;</span><span class="p">,</span><span class="s1">&#39;charge_prevstate_in&#39;</span><span class="p">],</span>
                             <span class="n">output_keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;charge_targetloc_out&#39;</span><span class="p">,</span><span class="s1">&#39;charge_prevstate_out&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loop_count</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># variable containing the number of times the robot waited 0.5 sec</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">charge_time</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="s1">&#39;/state_machine/charge_time&#39;</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">)</span> <span class="c1"># retrieve the charging time from the parameter serve -&gt; 5.0 s is the default value.</span>
        <span class="n">EnvironmentOntology</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        
<div class="viewcode-block" id="Charge.execute"><a class="viewcode-back" href="../../index.html#scripts.state_machine.Charge.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">userdata</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Function that is called every time that this state is executed.</span>

<span class="sd">        |  The function simply makes the process sleep for the desired charging time (5 s by default). However, during this period of time, the global variable &#39;tansition&#39; is checked 10 times in order to detect possible &#39;battery_low&#39; signals that have been issued.</span>
<span class="sd">        |  After the total amount of time, if the value of the global variable &#39;transition&#39; has not changed into &#39;battery low&#39;, it is assigned with the string &#39;battery_full&#39;.</span>
<span class="sd">        |  At the end of the fuction, the &#39;update_room_stamp&#39; method belonging to the imported class named &#39;EnvironmentOntology&#39; is executed so as to update the timestamp that takes into account the last time a location was visited.</span>
<span class="sd">        |  Finally the global variable &#39;transition&#39; is returned.</span>

<span class="sd">        Args:</span>
<span class="sd">            self: variable that refers to the class instance</span>
<span class="sd">            userdata (struct): structure containing the input and output variables of the state</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># function called when exiting from the node, it can be blocking</span>

        <span class="k">global</span> <span class="n">transition</span>
        <span class="k">global</span> <span class="n">mutex</span>

        <span class="n">rospy</span><span class="o">.</span><span class="n">loginfo</span><span class="p">(</span><span class="s1">&#39;Executing state &#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[93m&#39;</span> <span class="o">+</span> <span class="s1">&#39;CHARGE &#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[0m&#39;</span> <span class="o">+</span> <span class="s1">&#39;(the previous state was: </span><span class="si">%d</span><span class="s1">)&#39;</span><span class="o">%</span><span class="n">userdata</span><span class="o">.</span><span class="n">charge_prevstate_in</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[93m&#39;</span> <span class="o">+</span> <span class="s1">&#39;-----------------------------------------------------------------------------&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[0m&#39;</span><span class="p">)</span> 

        <span class="n">mutex</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># print(&#39;\033[93m&#39; + &quot;\nstate Charge got the mutex (1)&quot; + &#39;\033[0m&#39;) # DEBUG</span>
            <span class="n">transition</span> <span class="o">=</span> <span class="s1">&#39;no_transition&#39;</span> <span class="c1">#otherwise if I don&#39;t enter the if the transition won&#39;t be reset</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">mutex</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

        <span class="c1"># --------------------</span>

        <span class="k">if</span><span class="p">(</span><span class="n">userdata</span><span class="o">.</span><span class="n">charge_prevstate_in</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">):</span> <span class="c1"># if the previous state was not this one (&#39;Charge&#39;)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loop_count</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># restart the loop counter</span>
        
        <span class="c1"># Wait some time (5 seconds by default) if the transition global variable remains &#39;no_transition&#39;</span>
        <span class="c1"># This procedure of waiting is implemented to be NOT atomic, since hypothetically it can happen that a battery_low signal randomly arrives</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&gt; Waiting </span><span class="si">{0}</span><span class="s2"> seconds for letting the battery recharge...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">charge_time</span><span class="p">))</span>

        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[92m&#39;</span> <span class="o">+</span> <span class="s2">&quot;Battery: &quot;</span> <span class="o">+</span> <span class="s2">&quot;[</span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="p">(</span><span class="mi">5</span><span class="o">*</span><span class="mi">10</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[0m&#39;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\b</span><span class="s2">&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="mi">5</span><span class="o">*</span><span class="mi">10</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>

        <span class="k">while</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loop_count</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">):</span>
            <span class="n">mutex</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
            <span class="c1"># print(&#39;\033[93m&#39; + &quot;\nstate Charge got the mutex (2)&quot; + &#39;\033[0m&#39;) # DEBUG</span>
            <span class="k">if</span><span class="p">(</span><span class="n">transition</span> <span class="o">==</span> <span class="s1">&#39;no_transition&#39;</span><span class="p">):</span> <span class="c1"># wait charge_time/10 sec and check the transition global variable again</span>
                <span class="n">mutex</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[92m&#39;</span> <span class="o">+</span> <span class="s2">&quot;+++++&quot;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[0m&#39;</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">charge_time</span><span class="o">/</span><span class="mi">10</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">loop_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop_count</span><span class="o">+</span><span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mutex</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
                <span class="k">break</span>

        <span class="n">mutex</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">if</span><span class="p">(</span><span class="n">transition</span> <span class="o">==</span> <span class="s1">&#39;no_transition&#39;</span><span class="p">):</span>
            <span class="c1"># print(&#39;\033[93m&#39; + &quot;\nstate Charge got the mutex (3)&quot; + &#39;\033[0m&#39;) # DEBUG</span>
            <span class="n">transition</span> <span class="o">=</span> <span class="s1">&#39;battery_full&#39;</span>
        <span class="n">mutex</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

        <span class="c1"># --------------------</span>

        <span class="c1"># Update the visitedAt property of the charging room</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&gt; Updating the visitedAt timestamp of the charging room to the instant the robot exits the state &#39;Charge&#39;...&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_room_stamp</span><span class="p">()</span>

        <span class="c1"># --------------------</span>

        <span class="n">userdata</span><span class="o">.</span><span class="n">charge_targetloc_out</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="c1"># yield as output shared variable an empty string, since no target location has to be passed to the next state</span>
        <span class="n">userdata</span><span class="o">.</span><span class="n">charge_prevstate_out</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[93m&#39;</span> <span class="o">+</span> <span class="s1">&#39;-----------------------------------------------------------------------------&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[0m&#39;</span><span class="p">)</span> 

        <span class="k">return</span> <span class="n">transition</span></div></div>


<span class="c1"># define state Navigate</span>
<div class="viewcode-block" id="Navigate"><a class="viewcode-back" href="../../index.html#scripts.state_machine.Navigate">[docs]</a><span class="k">class</span> <span class="nc">Navigate</span><span class="p">(</span><span class="n">smach</span><span class="o">.</span><span class="n">State</span><span class="p">,</span><span class="n">EnvironmentOntology</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Class that defines a state whereby a path towards the goal location is generated and the robot is guided along such path.</span>

<span class="sd">    .. note::</span>

<span class="sd">        |  The possible outcomes of the implemented state are the strings &#39;battery_low&#39; and &#39;target_reached&#39;.</span>
<span class="sd">        |  The variable &#39;sm_targetloc&#39; shared among the states here is referred as: &#39;navigate_targetloc_in&#39; (as far as the input value is concerned) and &#39;navigate_targetloc_out&#39; (as far as the output value is concerned).</span>
<span class="sd">        |  It contains the location the robot should reach.</span>
<span class="sd">        |  The variable &#39;sm_prevstate&#39; shared among the states here is referred as: &#39;navigate_prevstate_in&#39; (as far as the input value is concerned) and &#39;navigate_prevstate_out&#39; (as far as the output value is concerned).</span>
<span class="sd">        |  It contains the previous state identifier.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot; (constructor) Function that is called whenever an instance of this class is defined.</span>

<span class="sd">        The function mainly executes the constructor of the father class &#39;EnvironmentOntology&#39; so as to inherit the attributes defined in there.</span>

<span class="sd">        Args:</span>
<span class="sd">            self: variable that refers to the class instance</span>
<span class="sd">            outcomes (str list): list containing all the possible strings that make the process exit this state</span>
<span class="sd">            input_keys (str list): list containing the names of the input variables used in this state</span>
<span class="sd">            output_keys (str list): list containing the names of the output variables used in this state</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># initialisation function, it should not wait</span>
        <span class="n">smach</span><span class="o">.</span><span class="n">State</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                             <span class="n">outcomes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;battery_low&#39;</span><span class="p">,</span><span class="s1">&#39;target_reached&#39;</span><span class="p">],</span>
                             <span class="n">input_keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;navigate_targetloc_in&#39;</span><span class="p">,</span><span class="s1">&#39;navigate_prevstate_in&#39;</span><span class="p">],</span>
                             <span class="n">output_keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;navigate_targetloc_out&#39;</span><span class="p">,</span><span class="s1">&#39;navigate_prevstate_out&#39;</span><span class="p">])</span>
        <span class="n">EnvironmentOntology</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        
<div class="viewcode-block" id="Navigate.execute"><a class="viewcode-back" href="../../index.html#scripts.state_machine.Navigate.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">userdata</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Function that is called every time that this state is executed.</span>

<span class="sd">        |  First, a request to the &#39;planner&#39; server, containing the desired location that has been determined in the &#39;Reason&#39; state, is sent. The server generates and returns a series of via-point towards the location at issue. </span>
<span class="sd">        |  This list is passed on in form of a request to the &#39;controller&#39; server which guides the robot along such path. During the accomplishment of this task the global variable &#39;transition&#39; is continuously checked.</span>
<span class="sd">        |  If, by the time the &#39;controller&#39; server finished performing the task, the value of the global variable &#39;transition&#39; has not changed into &#39;battery low&#39;, it is assigned with the string &#39;target_reached&#39;.</span>
<span class="sd">        |  At the beginning of the fuction, the &#39;update_room_stamp&#39; method belonging to the imported class named &#39;EnvironmentOntology&#39; is executed so as to update the timestamp that takes into account the last time a location was visited.</span>
<span class="sd">        |  At the end of the function instead, once the &#39;controller&#39; server returned succesfully, the &#39;update_robot_location&#39; and &#39;update_robot_stamp&#39; methods are executed so as to update both the robot timestamp related to the last time it moved and its location.</span>
<span class="sd">        |  Finally the global variable &#39;transition&#39; is returned.</span>

<span class="sd">        Args:</span>
<span class="sd">            self: variable that refers to the class instance</span>
<span class="sd">            userdata (struct): structure containing the input and output variables of the state</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># function called when exiting from the node, it can be blocking</span>
        
        <span class="k">global</span> <span class="n">transition</span>
        <span class="k">global</span> <span class="n">mutex</span>

        <span class="n">rospy</span><span class="o">.</span><span class="n">loginfo</span><span class="p">(</span><span class="s1">&#39;Executing state &#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[93m&#39;</span> <span class="o">+</span> <span class="s1">&#39;NAVIGATE &#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[0m&#39;</span> <span class="o">+</span> <span class="s1">&#39;(the previous state was: </span><span class="si">%d</span><span class="s1">)&#39;</span><span class="o">%</span><span class="n">userdata</span><span class="o">.</span><span class="n">navigate_prevstate_in</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[93m&#39;</span> <span class="o">+</span> <span class="s1">&#39;-----------------------------------------------------------------------------&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[0m&#39;</span><span class="p">)</span> 

        <span class="n">mutex</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># print(&#39;\033[93m&#39; + &quot;\nstate Navigate got the mutex (1)&quot; + &#39;\033[0m&#39;) # DEBUG</span>
            <span class="n">transition</span> <span class="o">=</span> <span class="s1">&#39;no_transition&#39;</span> <span class="c1"># I reset the transition so that from this time on I can catch new transitions</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">mutex</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

        <span class="c1"># --------------------</span>

        <span class="c1"># Update the visitedAt property of the location that the robot is leaving</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&gt; Updating the visitedAt timestamp of the location to the instant the robot starts leaving it...&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_room_stamp</span><span class="p">()</span>

        <span class="c1"># --------------------</span>

        <span class="c1"># Make a request to the planning server</span>
        <span class="n">via_points_list</span> <span class="o">=</span> <span class="n">plan</span><span class="p">(</span><span class="n">userdata</span><span class="o">.</span><span class="n">navigate_targetloc_in</span><span class="p">)</span> <span class="c1"># this function is atomic: can&#39;t be interrupted by a battery_low signal</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The path to location &quot;</span> <span class="o">+</span> <span class="n">userdata</span><span class="o">.</span><span class="n">navigate_targetloc_in</span> <span class="o">+</span> <span class="s2">&quot; has been generated&quot;</span><span class="p">)</span>
        <span class="c1"># print(via_points_list) # DEBUG</span>

        <span class="c1"># --------------------</span>

        <span class="c1"># Make a request to the controlling server</span>
        <span class="n">control</span><span class="p">(</span><span class="n">via_points_list</span><span class="p">)</span>

        <span class="c1"># Wait for the end of the controlling task unless a new transition arrives</span>
        <span class="n">mutex</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">while</span><span class="p">(</span><span class="n">transition</span> <span class="o">==</span> <span class="s1">&#39;no_transition&#39;</span><span class="p">):</span>
            <span class="n">mutex</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">actcli_control</span><span class="o">.</span><span class="n">get_state</span><span class="p">()</span> <span class="o">==</span> <span class="mi">3</span><span class="p">):</span> <span class="c1"># aka the random point has been reached</span>

                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Location &quot;</span> <span class="o">+</span> <span class="n">userdata</span><span class="o">.</span><span class="n">navigate_targetloc_in</span> <span class="o">+</span> <span class="s2">&quot; has been reached&quot;</span><span class="p">)</span>

                <span class="c1"># Update the location and now property of the robot (timestamp of the last time that the robot moved)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">update_robot_location</span><span class="p">(</span><span class="n">userdata</span><span class="o">.</span><span class="n">navigate_targetloc_in</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">update_robot_stamp</span><span class="p">()</span>

                <span class="c1"># -------------------</span>

                <span class="n">mutex</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># print(&#39;\033[93m&#39; + &quot;\nstate Navigate got the mutex (2)&quot; + &#39;\033[0m&#39;) # DEBUG</span>
                    <span class="n">transition</span> <span class="o">=</span> <span class="s1">&#39;target_reached&#39;</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="n">mutex</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

            <span class="n">mutex</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="n">mutex</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

        <span class="n">userdata</span><span class="o">.</span><span class="n">navigate_targetloc_out</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="c1"># yield as output shared variable an empty string, since no target location has to be passed to the next state</span>
        <span class="n">userdata</span><span class="o">.</span><span class="n">navigate_prevstate_out</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[93m&#39;</span> <span class="o">+</span> <span class="s1">&#39;-----------------------------------------------------------------------------&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[0m&#39;</span><span class="p">)</span> 

        <span class="k">return</span> <span class="n">transition</span></div></div>


<span class="c1"># define state NavigatetoCharge</span>
<div class="viewcode-block" id="NavigatetoCharge"><a class="viewcode-back" href="../../index.html#scripts.state_machine.NavigatetoCharge">[docs]</a><span class="k">class</span> <span class="nc">NavigatetoCharge</span><span class="p">(</span><span class="n">smach</span><span class="o">.</span><span class="n">State</span><span class="p">,</span><span class="n">EnvironmentOntology</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Class that defines a state whereby a path towards the charging room is generated and the robot is guided along such path.</span>

<span class="sd">    .. note::</span>

<span class="sd">        |  The possible outcomes of the implemented state are the strings &#39;battery_low&#39; and &#39;target_reached&#39;.</span>
<span class="sd">        |  The variable &#39;sm_targetloc&#39; shared among the states here is referred as: &#39;navigatetocharge_targetloc_in&#39; (as far as the input value is concerned) and &#39;navigatetocharge_targetloc_out&#39; (as far as the output value is concerned).</span>
<span class="sd">        |  It contains the location the robot should reach.</span>
<span class="sd">        |  The variable &#39;sm_prevstate&#39; shared among the states here is referred as: &#39;navigatetocharge_prevstate_in&#39; (as far as the input value is concerned) and &#39;navigatetocharge_prevstate_out&#39; (as far as the output value is concerned).</span>
<span class="sd">        |  It contains the previous state identifier.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot; (constructor) Function that is called whenever an instance of this class is defined.</span>

<span class="sd">        The function mainly executes the constructor of the father class &#39;EnvironmentOntology&#39; so as to inherit the attributes defined in there.</span>

<span class="sd">        Args:</span>
<span class="sd">            self: variable that refers to the class instance</span>
<span class="sd">            outcomes (str list): list containing all the possible strings that make the process exit this state</span>
<span class="sd">            input_keys (str list): list containing the names of the input variables used in this state</span>
<span class="sd">            output_keys (str list): list containing the names of the output variables used in this state</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># initialisation function, it should not wait</span>
        <span class="n">smach</span><span class="o">.</span><span class="n">State</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                             <span class="n">outcomes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;battery_low&#39;</span><span class="p">,</span><span class="s1">&#39;target_reached&#39;</span><span class="p">],</span>
                             <span class="n">input_keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;navigatetocharge_targetloc_in&#39;</span><span class="p">,</span><span class="s1">&#39;navigatetocharge_prevstate_in&#39;</span><span class="p">],</span>
                             <span class="n">output_keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;navigatetocharge_targetloc_out&#39;</span><span class="p">,</span><span class="s1">&#39;navigatetocharge_prevstate_out&#39;</span><span class="p">])</span>
        <span class="n">EnvironmentOntology</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        
<div class="viewcode-block" id="NavigatetoCharge.execute"><a class="viewcode-back" href="../../index.html#scripts.state_machine.NavigatetoCharge.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">userdata</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Function that is called every time that this state is executed.</span>

<span class="sd">        |  If the previous state was not &#39;NavigatetoCharge&#39;, possible control goals are cancelled. Then, if the robot is not already in the charging room, a request to the &#39;planner&#39; server, containing the charging room, is sent. </span>
<span class="sd">        |  The server generates and returns a series of via-points towards the location at issue. This list is passed on in form of a request to the &#39;controller&#39; server which guides the robot along such path. </span>
<span class="sd">        |  During the accomplishment of this task the global variable &#39;transition&#39; is continuously checked. If, by the time the &#39;controller&#39; server finished performing the task, the value of the global variable &#39;transition&#39; has not changed into &#39;battery low&#39;, it is assigned with the string &#39;target_reached&#39;.</span>
<span class="sd">        |  If it is the case that the robot is already in the charging room, the planning and controlling are not performed and simply the global variable is updated to &#39;target_reached&#39;.</span>
<span class="sd">        |  At the beginning of the fuction, the &#39;update_room_stamp&#39; method belonging to the imported class named &#39;EnvironmentOntology&#39; is executed so as to update the timestamp that takes into account the last time a location was visited.</span>
<span class="sd">        |  At the end of the function instead, either once the &#39;controller&#39; server returned succesfully or once the process detects that the robot is already in the charging room, the &#39;update_robot_location&#39; and &#39;update_robot_stamp&#39; methods are executed so as to update both the robot timestamp related to the last time it moved and its location.</span>
<span class="sd">        |  Finally the global variable &#39;transition&#39; is returned.</span>

<span class="sd">        Args:</span>
<span class="sd">            self: variable that refers to the class instance</span>
<span class="sd">            userdata (struct): structure containing the input and output variables of the state</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># function called when exiting from the node, it can be blocking</span>
        
        <span class="k">global</span> <span class="n">transition</span>
        <span class="k">global</span> <span class="n">mutex</span>

        <span class="n">rospy</span><span class="o">.</span><span class="n">loginfo</span><span class="p">(</span><span class="s1">&#39;Executing state &#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[93m&#39;</span> <span class="o">+</span> <span class="s1">&#39;NAVIGATETOCHARGE &#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[0m&#39;</span> <span class="o">+</span> <span class="s1">&#39;(the previous state was: </span><span class="si">%d</span><span class="s1">)&#39;</span><span class="o">%</span><span class="n">userdata</span><span class="o">.</span><span class="n">navigatetocharge_prevstate_in</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[93m&#39;</span> <span class="o">+</span> <span class="s1">&#39;-----------------------------------------------------------------------------&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[0m&#39;</span><span class="p">)</span> 

        <span class="n">mutex</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># print(&#39;\033[93m&#39; + &quot;\nstate NavigatetoCharge got the mutex (1)&quot; + &#39;\033[0m&#39;) # DEBUG</span>
            <span class="n">transition</span> <span class="o">=</span> <span class="s1">&#39;no_transition&#39;</span> <span class="c1"># I reset the transition so that from this time on I can catch new transitions</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">mutex</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

        <span class="c1"># --------------------</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">userdata</span><span class="o">.</span><span class="n">navigatetocharge_prevstate_in</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">):</span> <span class="c1"># if the previous state was not this one (&#39;NavigatetoCharge&#39;)</span>
        
            <span class="c1"># Cancel previous control goals</span>
            <span class="n">cancel_control_goals</span><span class="p">()</span>

            <span class="c1"># --------------------</span>

            <span class="c1"># Update the visitedAt property of the location that the robot is leaving</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&gt; Updating the visitedAt timestamp of the location to the instant the robot starts leaving it...&quot;</span><span class="p">)</span>
            <span class="n">current_location</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_room_stamp</span><span class="p">()</span>

            <span class="c1"># --------------------</span>

            <span class="k">if</span><span class="p">(</span><span class="n">current_location</span> <span class="o">!=</span> <span class="s1">&#39;E0&#39;</span><span class="p">):</span>

                <span class="c1"># Make a request to the planning server</span>
                <span class="n">via_points_list</span> <span class="o">=</span> <span class="n">plan</span><span class="p">(</span><span class="s1">&#39;E0&#39;</span><span class="p">)</span> <span class="c1"># this function is atomic: can&#39;t be interrupted by a battery_low signal</span>

                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The path to location E0 has been generated&quot;</span><span class="p">)</span>
                <span class="c1"># print(via_points_list) # DEBUG</span>

                <span class="c1"># --------------------</span>

                <span class="c1"># Make a request to the controlling server</span>
                <span class="n">control</span><span class="p">(</span><span class="n">via_points_list</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Already in location E0&quot;</span><span class="p">)</span>

                <span class="c1"># Update the now property of the robot (timestamp of the last time that the robot moved)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">update_robot_stamp</span><span class="p">()</span>

                <span class="n">mutex</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># print(&#39;\033[93m&#39; + &quot;\nstate NavigatetoCharge got the mutex (2)&quot; + &#39;\033[0m&#39;) # DEBUG</span>
                    <span class="n">transition</span> <span class="o">=</span> <span class="s1">&#39;target_reached&#39;</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="n">mutex</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

        <span class="c1"># Wait for the end of the controlling task unless a new transition arrives</span>
        <span class="n">mutex</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">while</span><span class="p">(</span><span class="n">transition</span> <span class="o">==</span> <span class="s1">&#39;no_transition&#39;</span><span class="p">):</span>
            <span class="n">mutex</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">actcli_control</span><span class="o">.</span><span class="n">get_state</span><span class="p">()</span> <span class="o">==</span> <span class="mi">3</span><span class="p">):</span> <span class="c1"># aka the random point has been reached</span>

                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Location E0 has been reached&quot;</span><span class="p">)</span>

                <span class="c1"># Update the location and now property of the robot (timestamp of the last time that the robot moved)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">update_robot_location</span><span class="p">(</span><span class="s1">&#39;E0&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">update_robot_stamp</span><span class="p">()</span>

                <span class="c1"># -------------------</span>

                <span class="n">mutex</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># print(&#39;\033[93m&#39; + &quot;\nstate NavigatetoCharge got the mutex (3)&quot; + &#39;\033[0m&#39;) # DEBUG</span>
                    <span class="n">transition</span> <span class="o">=</span> <span class="s1">&#39;target_reached&#39;</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="n">mutex</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
                
            <span class="n">mutex</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="n">mutex</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

        <span class="n">userdata</span><span class="o">.</span><span class="n">navigatetocharge_targetloc_out</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="c1"># yield as output shared variable an empty string, since no target location has to be passed to the next state</span>
        <span class="n">userdata</span><span class="o">.</span><span class="n">navigatetocharge_prevstate_out</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[93m&#39;</span> <span class="o">+</span> <span class="s1">&#39;-----------------------------------------------------------------------------&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[0m&#39;</span><span class="p">)</span> 

        <span class="k">return</span> <span class="n">transition</span></div></div>


<span class="c1"># define state Wait</span>
<div class="viewcode-block" id="Wait"><a class="viewcode-back" href="../../index.html#scripts.state_machine.Wait">[docs]</a><span class="k">class</span> <span class="nc">Wait</span><span class="p">(</span><span class="n">smach</span><span class="o">.</span><span class="n">State</span><span class="p">,</span><span class="n">EnvironmentOntology</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Class that defines a state that simulates the robot exploring the reached location.</span>

<span class="sd">    .. note::</span>

<span class="sd">        |  The possible outcomes of the implemented state are the strings &#39;battery_low&#39; and &#39;waited_enough&#39;.</span>
<span class="sd">        |  The variable &#39;sm_targetloc&#39; shared among the states here is referred as: &#39;wait_targetloc_in&#39; (as far as the input value is concerned) and &#39;wait_targetloc_out&#39; (as far as the output value is concerned).</span>
<span class="sd">        |  It contains the location the robot should reach.</span>
<span class="sd">        |  The variable &#39;sm_prevstate&#39; shared among the states here is referred as: &#39;wait_prevstate_in&#39; (as far as the input value is concerned) and &#39;wait_prevstate_out&#39; (as far as the output value is concerned).</span>
<span class="sd">        |  It contains the previous state identifier.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot; (constructor) Function that is called whenever an instance of this class is defined.</span>

<span class="sd">        The function initialises a loop counter and executes the constructor of the father class &#39;EnvironmentOntology&#39; so as to inherit the attributes defined in there.</span>

<span class="sd">        Args:</span>
<span class="sd">            self: variable that refers to the class instance</span>
<span class="sd">            outcomes (str list): list containing all the possible strings that make the process exit this state</span>
<span class="sd">            input_keys (str list): list containing the names of the input variables used in this state</span>
<span class="sd">            output_keys (str list): list containing the names of the output variables used in this state</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># initialisation function, it should not wait</span>
        <span class="n">smach</span><span class="o">.</span><span class="n">State</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                             <span class="n">outcomes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;battery_low&#39;</span><span class="p">,</span><span class="s1">&#39;waited_enough&#39;</span><span class="p">],</span>
                             <span class="n">input_keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;wait_targetloc_in&#39;</span><span class="p">,</span><span class="s1">&#39;wait_prevstate_in&#39;</span><span class="p">],</span>
                             <span class="n">output_keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;wait_targetloc_out&#39;</span><span class="p">,</span><span class="s1">&#39;wait_prevstate_out&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loop_count</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># variable containing the number of times the robot waited 0.5 sec</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">explore_time</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="s1">&#39;/state_machine/explore_time&#39;</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">)</span> <span class="c1"># retrieve the exploring time from the parameter server -&gt; 5.0 s is the default value.</span>
        <span class="n">EnvironmentOntology</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        
<div class="viewcode-block" id="Wait.execute"><a class="viewcode-back" href="../../index.html#scripts.state_machine.Wait.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">userdata</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Function that is called every time that this state is executed.</span>

<span class="sd">        |  The function simply makes the process sleep for the desired &#39;exploring&#39; time (5 s by default). However, during this period of time, the global variable &#39;tansition&#39; is checked 10 times in order to detect possible &#39;battery_low&#39; signals that have been issued.</span>
<span class="sd">        |  After the total amount of time, if the value of the global variable &#39;transition&#39; has not changed into &#39;battery low&#39;, it is assigned with the string &#39;waited_enough&#39;.</span>
<span class="sd">        |  At the end of the fuction, the &#39;update_room_stamp&#39; method belonging to the imported class named &#39;EnvironmentOntology&#39; is executed so as to update the timestamp that takes into account the last time a location was visited.</span>
<span class="sd">        |  Finally the global variable &#39;transition&#39; is returned.</span>

<span class="sd">        Args:</span>
<span class="sd">            self: variable that refers to the class instance</span>
<span class="sd">            userdata (struct): structure containing the input and output variables of the state</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># function called when exiting from the node, it can be blocking</span>
        
        <span class="k">global</span> <span class="n">transition</span>
        <span class="k">global</span> <span class="n">mutex</span>
        
        <span class="n">rospy</span><span class="o">.</span><span class="n">loginfo</span><span class="p">(</span><span class="s1">&#39;Executing state &#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[93m&#39;</span> <span class="o">+</span> <span class="s1">&#39;WAIT &#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[0m&#39;</span> <span class="o">+</span> <span class="s1">&#39;(the previous state was: </span><span class="si">%d</span><span class="s1">)&#39;</span><span class="o">%</span><span class="n">userdata</span><span class="o">.</span><span class="n">wait_prevstate_in</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[93m&#39;</span> <span class="o">+</span> <span class="s1">&#39;-----------------------------------------------------------------------------&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[0m&#39;</span><span class="p">)</span>  

        <span class="n">mutex</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># print(&#39;\033[93m&#39; + &quot;\nstate Wait got the mutex (1)&quot; + &#39;\033[0m&#39;) # DEBUG</span>
            <span class="n">transition</span> <span class="o">=</span> <span class="s1">&#39;no_transition&#39;</span> <span class="c1"># I reset the transition so that from this time on I can catch new transitions</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">mutex</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

        <span class="c1"># --------------------</span>

        <span class="k">if</span><span class="p">(</span><span class="n">userdata</span><span class="o">.</span><span class="n">wait_prevstate_in</span> <span class="o">!=</span> <span class="mi">5</span><span class="p">):</span> <span class="c1"># if the previous state was not this one (&#39;Wait&#39;)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loop_count</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># restart the loop counter</span>
        
        <span class="c1"># Wait some time (5 seconds by default) if the transition global variable remains &#39;no_transition&#39;</span>
        <span class="c1"># This procedure of waiting is implemented to be NOT atomic, since hypothetically the robot doesn&#39;t just wait, but explores the room, so it can</span>
        <span class="c1"># happen that a battery_low signal arrives</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&gt; Waiting </span><span class="si">{0}</span><span class="s2"> seconds for exploring the reached location...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">explore_time</span><span class="p">))</span>

        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[94m&#39;</span> <span class="o">+</span> <span class="s2">&quot;Exploration: &quot;</span> <span class="s2">&quot;[</span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="p">(</span><span class="mi">5</span><span class="o">*</span><span class="mi">10</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[0m&#39;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\b</span><span class="s2">&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="mi">5</span><span class="o">*</span><span class="mi">10</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>

        <span class="k">while</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loop_count</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">):</span>
            <span class="n">mutex</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
            <span class="c1"># print(&#39;\033[93m&#39; + &quot;\nstate Wait got the mutex (2)&quot; + &#39;\033[0m&#39;) # DEBUG</span>
            <span class="k">if</span><span class="p">(</span><span class="n">transition</span> <span class="o">==</span> <span class="s1">&#39;no_transition&#39;</span><span class="p">):</span> <span class="c1"># wait explore_time/10 sec and check the transition global variable again</span>
                <span class="n">mutex</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[94m&#39;</span> <span class="o">+</span> <span class="s2">&quot;#####&quot;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[0m&#39;</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">explore_time</span><span class="o">/</span><span class="mi">10</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">loop_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop_count</span><span class="o">+</span><span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mutex</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
                <span class="k">break</span>

        <span class="n">mutex</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">if</span><span class="p">(</span><span class="n">transition</span> <span class="o">==</span> <span class="s1">&#39;no_transition&#39;</span><span class="p">):</span>
            <span class="c1"># print(&#39;\033[93m&#39; + &quot;\nstate Wait got the mutex (3)&quot; + &#39;\033[0m&#39;) # DEBUG</span>
            <span class="n">transition</span> <span class="o">=</span> <span class="s1">&#39;waited_enough&#39;</span>
        <span class="n">mutex</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

        <span class="c1"># --------------------</span>

        <span class="c1"># Update the visitedAt property of the location that the robot reached</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&gt; Updating the visitedAt timestamp of the location to the instant the robot exits the state &#39;Wait&#39;...&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_room_stamp</span><span class="p">()</span>

        <span class="c1"># --------------------</span>

        <span class="n">userdata</span><span class="o">.</span><span class="n">wait_targetloc_out</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="c1"># yield as output shared variable an empty string, since no target location has to be passed to the next state       </span>
        <span class="n">userdata</span><span class="o">.</span><span class="n">wait_prevstate_out</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[93m&#39;</span> <span class="o">+</span> <span class="s1">&#39;-----------------------------------------------------------------------------&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[0m&#39;</span><span class="p">)</span>  

        <span class="k">return</span> <span class="n">transition</span></div></div>

<span class="c1">#==================================================================================================================</span>

<span class="c1"># MAIN</span>

<div class="viewcode-block" id="main"><a class="viewcode-back" href="../../index.html#scripts.state_machine.main">[docs]</a><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>

    <span class="sd">&quot;&quot;&quot;Function that first initializes and defines the subscriber to the &#39;/state/battery_low&#39; topic, then it starts the &#39;smach&#39; state-machine and finally spins to allow the cyclical execution of these mechanisms.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">rospy</span><span class="o">.</span><span class="n">init_node</span><span class="p">(</span><span class="s1">&#39;state_machine&#39;</span><span class="p">)</span>

    <span class="c1"># DEFINE SUBSCRIBERS ---------------------------------------------------------------------------</span>
    <span class="n">sub_batterylow</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Subscriber</span><span class="p">(</span><span class="s1">&#39;/state/battery_low&#39;</span><span class="p">,</span> <span class="n">Bool</span><span class="p">,</span> <span class="n">clbk_battery</span><span class="p">)</span> <span class="c1">#define and initialize the subscriber to the topic &#39;/state/battery_low&#39;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[93m&#39;</span> <span class="o">+</span> <span class="s1">&#39;-----------------------------------------------------------------------------&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[0m&#39;</span><span class="p">)</span> 
    <span class="c1"># CREATE A SMACH STATE MACHINE -----------------------------------------------------------------------------------------</span>
    <span class="n">sm</span> <span class="o">=</span> <span class="n">smach</span><span class="o">.</span><span class="n">StateMachine</span><span class="p">(</span><span class="n">outcomes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;container_interface&#39;</span><span class="p">])</span>
    <span class="n">sm</span><span class="o">.</span><span class="n">userdata</span><span class="o">.</span><span class="n">sm_targetloc</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="c1"># variable shared among all states -&gt; it contains the target location to reach. At the beginning it is &quot;&quot;.</span>
    <span class="n">sm</span><span class="o">.</span><span class="n">userdata</span><span class="o">.</span><span class="n">sm_prevstate</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="c1"># variable shared among all states -&gt; it contains the previous state. At the beginning it is 0.</span>

    <span class="c1"># Open the container</span>
    <span class="k">with</span> <span class="n">sm</span><span class="p">:</span>
        <span class="c1"># Add states to the container</span>
        <span class="c1"># &#39;done_reasoning&#39;, &#39;target_reached&#39;, &#39;waited_enough&#39; and &#39;battery_full&#39; are not transitions that can randomly happen like &#39;battery_low&#39;, so they don&#39;t appear in every state</span>
        <span class="n">smach</span><span class="o">.</span><span class="n">StateMachine</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;BUILDENVIRONMENT&#39;</span><span class="p">,</span> <span class="n">BuildEnvironment</span><span class="p">(),</span> 
                               <span class="n">transitions</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;environment_built&#39;</span><span class="p">:</span><span class="s1">&#39;REASON&#39;</span><span class="p">},</span>
                               <span class="n">remapping</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;buildenvironment_targetloc_in&#39;</span><span class="p">:</span><span class="s1">&#39;sm_targetloc&#39;</span><span class="p">,</span>
                                          <span class="s1">&#39;buildenvironment_targetloc_out&#39;</span><span class="p">:</span><span class="s1">&#39;sm_targetloc&#39;</span><span class="p">,</span>
                                          <span class="s1">&#39;buildenvironment_prevstate_in&#39;</span><span class="p">:</span><span class="s1">&#39;sm_prevstate&#39;</span><span class="p">,</span>
                                          <span class="s1">&#39;buildenvironment_prevstate_out&#39;</span><span class="p">:</span><span class="s1">&#39;sm_prevstate&#39;</span><span class="p">})</span>
        <span class="n">smach</span><span class="o">.</span><span class="n">StateMachine</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;REASON&#39;</span><span class="p">,</span> <span class="n">Reason</span><span class="p">(),</span> 
                               <span class="n">transitions</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;battery_low&#39;</span><span class="p">:</span><span class="s1">&#39;NAVIGATETOCHARGE&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;done_reasoning&#39;</span><span class="p">:</span><span class="s1">&#39;NAVIGATE&#39;</span><span class="p">},</span>
                               <span class="n">remapping</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;reason_targetloc_in&#39;</span><span class="p">:</span><span class="s1">&#39;sm_targetloc&#39;</span><span class="p">,</span> 
                                          <span class="s1">&#39;reason_targetloc_out&#39;</span><span class="p">:</span><span class="s1">&#39;sm_targetloc&#39;</span><span class="p">,</span>
                                          <span class="s1">&#39;reason_prevstate_in&#39;</span><span class="p">:</span><span class="s1">&#39;sm_prevstate&#39;</span><span class="p">,</span>
                                          <span class="s1">&#39;reason_prevstate_out&#39;</span><span class="p">:</span><span class="s1">&#39;sm_prevstate&#39;</span><span class="p">})</span>
        <span class="n">smach</span><span class="o">.</span><span class="n">StateMachine</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;CHARGE&#39;</span><span class="p">,</span> <span class="n">Charge</span><span class="p">(),</span> 
                               <span class="n">transitions</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;battery_low&#39;</span><span class="p">:</span><span class="s1">&#39;CHARGE&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;battery_full&#39;</span><span class="p">:</span><span class="s1">&#39;REASON&#39;</span><span class="p">},</span>
                               <span class="n">remapping</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;charge_targetloc_in&#39;</span><span class="p">:</span><span class="s1">&#39;sm_targetloc&#39;</span><span class="p">,</span>
                                          <span class="s1">&#39;charge_targetloc_out&#39;</span><span class="p">:</span><span class="s1">&#39;sm_targetloc&#39;</span><span class="p">,</span>
                                          <span class="s1">&#39;charge_prevstate_in&#39;</span><span class="p">:</span><span class="s1">&#39;sm_prevstate&#39;</span><span class="p">,</span>
                                          <span class="s1">&#39;charge_prevstate_out&#39;</span><span class="p">:</span><span class="s1">&#39;sm_prevstate&#39;</span><span class="p">})</span>
        <span class="n">smach</span><span class="o">.</span><span class="n">StateMachine</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;NAVIGATE&#39;</span><span class="p">,</span> <span class="n">Navigate</span><span class="p">(),</span> 
                               <span class="n">transitions</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;battery_low&#39;</span><span class="p">:</span><span class="s1">&#39;NAVIGATETOCHARGE&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;target_reached&#39;</span><span class="p">:</span><span class="s1">&#39;WAIT&#39;</span><span class="p">},</span>
                               <span class="n">remapping</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;navigate_targetloc_in&#39;</span><span class="p">:</span><span class="s1">&#39;sm_targetloc&#39;</span><span class="p">,</span>
                                          <span class="s1">&#39;navigate_targetloc_out&#39;</span><span class="p">:</span><span class="s1">&#39;sm_targetloc&#39;</span><span class="p">,</span>
                                          <span class="s1">&#39;navigate_prevstate_in&#39;</span><span class="p">:</span><span class="s1">&#39;sm_prevstate&#39;</span><span class="p">,</span>
                                          <span class="s1">&#39;navigate_prevstate_out&#39;</span><span class="p">:</span><span class="s1">&#39;sm_prevstate&#39;</span><span class="p">})</span>
        <span class="n">smach</span><span class="o">.</span><span class="n">StateMachine</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;NAVIGATETOCHARGE&#39;</span><span class="p">,</span> <span class="n">NavigatetoCharge</span><span class="p">(),</span> 
                               <span class="n">transitions</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;battery_low&#39;</span><span class="p">:</span><span class="s1">&#39;NAVIGATETOCHARGE&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;target_reached&#39;</span><span class="p">:</span><span class="s1">&#39;CHARGE&#39;</span><span class="p">},</span>
                               <span class="n">remapping</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;navigatetocharge_targetloc_in&#39;</span><span class="p">:</span><span class="s1">&#39;sm_targetloc&#39;</span><span class="p">,</span>
                                          <span class="s1">&#39;navigatetocharge_targetloc_out&#39;</span><span class="p">:</span><span class="s1">&#39;sm_targetloc&#39;</span><span class="p">,</span>
                                          <span class="s1">&#39;navigatetocharge_prevstate_in&#39;</span><span class="p">:</span><span class="s1">&#39;sm_prevstate&#39;</span><span class="p">,</span>
                                          <span class="s1">&#39;navigatetocharge_prevstate_out&#39;</span><span class="p">:</span><span class="s1">&#39;sm_prevstate&#39;</span><span class="p">})</span>
        <span class="n">smach</span><span class="o">.</span><span class="n">StateMachine</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;WAIT&#39;</span><span class="p">,</span> <span class="n">Wait</span><span class="p">(),</span> 
                               <span class="n">transitions</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;battery_low&#39;</span><span class="p">:</span><span class="s1">&#39;NAVIGATETOCHARGE&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;waited_enough&#39;</span><span class="p">:</span><span class="s1">&#39;REASON&#39;</span><span class="p">},</span>
                               <span class="n">remapping</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;wait_targetloc_in&#39;</span><span class="p">:</span><span class="s1">&#39;sm_targetloc&#39;</span><span class="p">,</span>
                                          <span class="s1">&#39;wait_targetloc_out&#39;</span><span class="p">:</span><span class="s1">&#39;sm_targetloc&#39;</span><span class="p">,</span>
                                          <span class="s1">&#39;wait_prevstate_in&#39;</span><span class="p">:</span><span class="s1">&#39;sm_prevstate&#39;</span><span class="p">,</span>
                                          <span class="s1">&#39;wait_prevstate_out&#39;</span><span class="p">:</span><span class="s1">&#39;sm_prevstate&#39;</span><span class="p">})</span>


    <span class="c1"># Create and start the introspection server for visualization</span>
    <span class="n">sis</span> <span class="o">=</span> <span class="n">smach_ros</span><span class="o">.</span><span class="n">IntrospectionServer</span><span class="p">(</span><span class="s1">&#39;server_name&#39;</span><span class="p">,</span> <span class="n">sm</span><span class="p">,</span> <span class="s1">&#39;/SM_ROOT&#39;</span><span class="p">)</span>
    <span class="n">sis</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="c1"># Execute the state machine</span>
    <span class="n">outcome</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>

    <span class="c1"># Wait for ctrl-c to stop the application</span>
    <span class="n">rospy</span><span class="o">.</span><span class="n">spin</span><span class="p">()</span>
    <span class="n">sis</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Emanuele Rambaldi.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>